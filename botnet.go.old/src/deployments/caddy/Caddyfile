# BotNet Registry Server
botnet.airon.games {
    # Enable TLS
    tls {
        dns cloudflare {env.CLOUDFLARE_API_TOKEN}
    }
    
    # Enable compression
    encode gzip
    
    # Security headers
    header {
        # HSTS
        Strict-Transport-Security max-age=31536000;
        # Content type sniffing protection
        X-Content-Type-Options nosniff
        # XSS protection
        X-Frame-Options DENY
        # Referrer policy
        Referrer-Policy strict-origin-when-cross-origin
        # Content Security Policy
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self'"
    }
    
    # Rate limiting
    rate_limit {
        zone registry_api {
            key {remote_host}
            events 100
            window 1m
        }
    }
    
    # Static files
    handle_path /static/* {
        root * /app/web/static
        file_server
    }
    
    # Web interface
    handle / {
        root * /app/web/templates
        templates
        file_server
    }
    
    # API endpoints
    handle /api/* {
        reverse_proxy localhost:8080 {
            header_up Host {upstream_hostport}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }
    
    # Health check
    handle /health {
        reverse_proxy localhost:8080
    }
    
    # WebSocket support for real-time features
    handle /ws {
        reverse_proxy localhost:8080 {
            header_up Connection {>Connection}
            header_up Upgrade {>Upgrade}
        }
    }
    
    # Logging
    log {
        output file /var/log/caddy/botnet-registry.log {
            roll_size 100mb
            roll_keep 5
            roll_keep_for 720h
        }
        format json
        level INFO
    }
    
    # Error handling
    handle_errors {
        @404 expression {http.error.status_code} == 404
        handle @404 {
            rewrite * /404.html
            file_server
        }
        
        @5xx expression {http.error.status_code} >= 500
        handle @5xx {
            rewrite * /500.html
            file_server
        }
    }
}

# Node Server Template
# Copy this block and customize for each domain node
# Example: botnet.example.com

(node_common) {
    # Common node configuration
    encode gzip
    
    # Security headers (same as registry)
    header {
        Strict-Transport-Security max-age=31536000;
        X-Content-Type-Options nosniff
        X-Frame-Options DENY
        Referrer-Policy strict-origin-when-cross-origin
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self'"
    }
    
    # Rate limiting for nodes
    rate_limit {
        zone node_api {
            key {remote_host}
            events 200
            window 1m
        }
    }
    
    # API endpoints
    handle /api/* {
        reverse_proxy localhost:8081 {
            header_up Host {upstream_hostport}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }
    
    # Health check
    handle /health {
        reverse_proxy localhost:8081
    }
    
    # WebSocket support
    handle /ws {
        reverse_proxy localhost:8081 {
            header_up Connection {>Connection}
            header_up Upgrade {>Upgrade}
        }
    }
    
    # Node-specific static content
    handle_path /static/* {
        root * /app/web/static
        file_server
    }
    
    # Default to API or node interface
    handle {
        reverse_proxy localhost:8081
    }
}

# Example node configuration (uncomment and customize)
# botnet.example.com {
#     import node_common
#     tls your-email@example.com
# }